// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id         String   @id @default(cuid())
  name       String
  type       String   // "cash" | "checking" | "savings" | "credit" | "investment" | "other"
  creditLimit Float?  // Limit for credit cards (null for other types)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  transactions         Transaction[]
  investmentAccounts  InvestmentAccount[]
  debts                Debt[]

  @@index([type])
}

model Macro {
  id        String   @id @default(cuid())
  name      String   // Unique constraint is partial: unique when userId IS NULL, unique (name, userId) when userId IS NOT NULL
  userId    String?  // NULL for system defaults, user ID for custom macros
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  categories Category[]
  budgets    Budget[]

  @@index([name])
  @@index([userId])
}

model Category {
  id        String   @id @default(cuid())
  name      String
  macroId   String
  macro     Macro    @relation(fields: [macroId], references: [id], onDelete: Cascade)
  userId    String?  // NULL for system defaults, user ID for custom categories
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  subcategories    Subcategory[]
  budgets          Budget[]
  budgetCategories BudgetCategory[]
  transactions     Transaction[]

  @@index([macroId])
  @@index([name])
  @@index([userId])
}

model Subcategory {
  id         String   @id @default(cuid())
  name       String
  categoryId String
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  userId     String?  // NULL for system defaults, user ID for custom subcategories
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  transactions Transaction[]

  @@index([categoryId])
  @@index([name])
  @@index([userId])
}

model Transaction {
  id            String   @id @default(cuid())
  date          DateTime
  type          String   // "expense" | "income" | "transfer"
  amount        Float
  accountId     String
  account       Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  categoryId    String?
  category      Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  subcategoryId String?
  subcategory   Subcategory? @relation(fields: [subcategoryId], references: [id], onDelete: SetNull)
  description   String?
  tags          String   @default("") // JSON array as string
  transferToId  String?  // For transfer transactions - points to destination account
  transferFromId String? // For transfer transactions - points to origin transaction
  recurring     Boolean  @default(false) // Indicates if transaction occurs every month
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([date])
  @@index([categoryId, date])
  @@index([accountId])
  @@index([type])
  @@index([date, type])
  @@index([recurring])
}

model Budget {
  id         String   @id @default(cuid())
  period     DateTime // First day of month
  categoryId String?  // Optional when macroId is present
  category   Category? @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  macroId    String?  // Optional when grouping multiple categories
  macro      Macro?    @relation(fields: [macroId], references: [id], onDelete: Cascade)
  amount     Float
  note       String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  budgetCategories BudgetCategory[]

  @@index([period])
  @@index([categoryId, period])
  @@index([macroId, period])
}

model InvestmentAccount {
  id        String   @id @default(cuid())
  name      String
  type      String   // "Wealthsimple" | "TFSA" | "RRSP" | "Crypto Wallet" | etc.
  accountId String?  // Link to Account if needed
  account   Account? @relation(fields: [accountId], references: [id], onDelete: SetNull)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  transactions InvestmentTransaction[]

  @@index([type])
}

model Security {
  id        String   @id @default(cuid())
  symbol    String   @unique
  name      String
  class     String   // "stock" | "etf" | "crypto" | "bond" | "reit"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  transactions InvestmentTransaction[]
  prices       SecurityPrice[]

  @@index([symbol])
  @@index([class])
}

model InvestmentTransaction {
  id              String   @id @default(cuid())
  date            DateTime
  accountId       String
  account         InvestmentAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)
  securityId      String?
  security        Security? @relation(fields: [securityId], references: [id], onDelete: SetNull)
  type            String   // "buy" | "sell" | "dividend" | "interest" | "transfer_in" | "transfer_out"
  quantity        Float?
  price           Float?
  fees            Float    @default(0)
  notes           String?
  transferToId    String?  // For transfer_in/out
  transferFromId  String?  // Points to other InvestmentTransaction for transfers
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([date])
  @@index([accountId])
  @@index([securityId])
  @@index([type])
}

model SecurityPrice {
  id        String   @id @default(cuid())
  securityId String
  security  Security @relation(fields: [securityId], references: [id], onDelete: Cascade)
  date      DateTime
  price     Float
  createdAt DateTime @default(now())

  @@unique([securityId, date])
  @@index([securityId, date])
}

model BudgetCategory {
  id         String   @id @default(cuid())
  budgetId   String
  budget     Budget   @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  categoryId String
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())

  @@unique([budgetId, categoryId])
  @@index([budgetId])
  @@index([categoryId])
}

model Debt {
  id                          String    @id @default(cuid())
  name                        String
  loanType                    String    // "mortgage" | "car_loan" | "personal_loan" | "credit_card" | "student_loan" | "business_loan" | "other"
  initialAmount               Float
  downPayment                 Float     @default(0)
  currentBalance              Float
  interestRate                Float     // Annual interest rate as percentage (e.g., 12.5 for 12.5%)
  totalMonths                 Int
  firstPaymentDate            DateTime
  monthlyPayment              Float
  paymentFrequency            String    @default("monthly") // "monthly" | "biweekly" | "weekly" | "semimonthly" | "daily"
  paymentAmount               Float?    // Payment amount based on frequency
  principalPaid               Float     @default(0)
  interestPaid                Float     @default(0)
  additionalContributions     Boolean   @default(false)
  additionalContributionAmount Float?   @default(0)
  priority                    String    @default("Medium") // "High" | "Medium" | "Low"
  description                 String?
  accountId                   String?
  account                     Account?  @relation(fields: [accountId], references: [id], onDelete: SetNull)
  isPaidOff                   Boolean   @default(false)
  isPaused                    Boolean   @default(false)
  paidOffAt                   DateTime?
  createdAt                   DateTime  @default(now())
  updatedAt                   DateTime  @updatedAt

  @@index([loanType])
  @@index([isPaidOff])
  @@index([isPaused])
  @@index([priority])
  @@index([firstPaymentDate])
  @@index([paymentFrequency])
  @@index([accountId])
}

model User {
  id        String   @id // UUID, references auth.users
  email     String
  name      String?
  avatarUrl String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  subscriptions Subscription[]

  @@index([email])
}

model Plan {
  id                  String   @id @default(cuid())
  name                String   @unique // "free" | "basic" | "premium"
  priceMonthly        Float    @default(0)
  priceYearly         Float    @default(0)
  features            String   @default("{}") // JSON string with limits
  stripePriceIdMonthly String?
  stripePriceIdYearly  String?
  stripeProductId      String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  subscriptions Subscription[]

  @@index([name])
}

model Subscription {
  id                  String   @id @default(cuid())
  userId              String // UUID, references User.id
  planId              String
  plan                Plan    @relation(fields: [planId], references: [id], onDelete: Restrict)
  status              String   @default("active") // "active" | "cancelled" | "past_due" | "trialing"
  stripeSubscriptionId String? @unique
  stripeCustomerId    String?
  currentPeriodStart  DateTime?
  currentPeriodEnd    DateTime?
  cancelAtPeriodEnd   Boolean @default(false)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([userId])
  @@index([planId])
  @@index([status])
  @@index([stripeSubscriptionId])
  @@index([stripeCustomerId])
}

